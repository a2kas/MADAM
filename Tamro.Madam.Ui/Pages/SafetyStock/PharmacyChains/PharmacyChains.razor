@page "/safety-stock/pharmacy-chains"
@using Tamro.Madam.Application.Queries.Items.SafetyStocks.PharmacyChains
@using Tamro.Madam.Models.Data
@using Tamro.Madam.Models.ItemMasterdata.Items.SafetyStocks.PharmacyChains
@using Tamro.Madam.Ui.Components.DataGrid.Filtering

<Permission RequiredPermission="@Permissions.CanViewSafetyStock" />
<PageTitle>Pharmacy chains</PageTitle>

<MudPaper>
    <MudGrid Class="d-flex">
        <MudItem sm="2" xs="12" Class="d-flex align-items-center">
            <MudIcon Icon="@Icons.Material.Filled.LocalPharmacy" Color="Color.Tertiary" Size="Size.Large" />
            <MudText Class="gap-4 ma-1" Typo="Typo.h6">Pharmacy chains</MudText>
        </MudItem>
        <MudItem sm="10" xs="12" Class="d-flex align-items-end justify-end button-bar">
            <MudButton Variant="Variant.Outlined"
                        OnClick="OnReset"
                        Size="Size.Small"
                        Disabled="@_loading"
                        StartIcon="@Icons.Material.Filled.Refresh" IconColor="Color.Surface" Color="Color.Primary"
                        Style="margin-right: 4px; margin-bottom:4px">
                 Reset
             </MudButton>
             <MudButton Variant="Variant.Outlined" Color="Color.Primary"
                        StartIcon="@Icons.Material.Filled.Add"
                        Size="Size.Small"
                        Disabled="@(_loading || !_userProfileState.Value.HasPermission(Permissions.CanManageSafetyStock))"
                        OnClick="OnCreate"
                        Style="margin-right: 4px; margin-bottom:4px"
                        IconColor="Color.Surface">
                 New
             </MudButton>
             <MudButton Variant="Variant.Outlined" Color="Color.Primary"
                        StartIcon="@Icons.Material.Filled.OpenInNew"
                        Size="Size.Small"
                        Disabled="@(_selectedPharmacyChains.Count != 1)"
                        OnClick="OnOpen"
                        Style="margin-right: 4px; margin-bottom:4px"
                        IconColor="Color.Surface">
                 Open
             </MudButton>
             <MudButton Variant="Variant.Outlined" Color="Color.Primary"
                        StartIcon="@Icons.Material.Filled.ContentCopy"
                        Size="Size.Small"
                        Disabled="@(_selectedPharmacyChains.Count != 1 || !_userProfileState.Value.HasPermission(Permissions.CanManageSafetyStock))"
                        OnClick="OnCopy"
                        Style="margin-right: 4px; margin-bottom:4px"
                        IconColor="Color.Surface">
                 Copy
             </MudButton>
             <MudButton Variant="Variant.Outlined" Color="Color.Primary"
                        StartIcon="@Icons.Material.Filled.ToggleOn"
                        Disabled="@(!(_selectedPharmacyChains.Count > 0 && !_selectedPharmacyChains.Any(x => x.IsActive)) || !_userProfileState.Value.HasPermission(Permissions.CanManageSafetyStock))"
                        Size="Size.Small"
                        Style="margin-right: 4px; margin-bottom:4px"
                        OnClick="OnActivate"
                        IconColor="Color.Surface">
                 Activate
             </MudButton>
             <MudButton Variant="Variant.Outlined" Color="Color.Error"
                        StartIcon="@Icons.Material.Filled.ToggleOff"
                        Disabled="@(!(_selectedPharmacyChains.Count > 0 && !_selectedPharmacyChains.Any(x => !x.IsActive)) || !_userProfileState.Value.HasPermission(Permissions.CanManageSafetyStock))"
                        Size="Size.Small"
                        Style="margin-right: 4px; margin-bottom:4px"
                        OnClick="OnDeactivate"
                        IconColor="Color.Surface">
                 Deactivate
             </MudButton>
            <MudButton Variant="Variant.Outlined" Color="Color.Primary"
                       StartIcon="@Icons.Material.Filled.History"
                       Disabled="@(_selectedPharmacyChains.Count != 1)"
                       Size="Size.Small"
                       Style="margin-right: 4px; margin-bottom:4px"
                       OnClick="OnHistoryView"
                       IconColor="Color.Surface">
                History
            </MudButton>
             <MudLoadingButton @bind-Loading="_loading" Variant="Variant.Outlined" Color="Color.Primary"
                               Label="Export"
                               Disabled="@_loading"
                               StartIcon="@Icons.Custom.FileFormats.FileExcel"
                               Size="Size.Small"
                               Style="margin-right: 4px; margin-bottom:4px"
                               OnClick="OnExport"
                               IconColor="Color.Surface">
                 Export
             </MudLoadingButton>
         </MudItem>
         <MudItem xs="12">
             <MudTextField T="string" Immediate="true" OnKeyDown="OnBasicSearchKeyDown" @bind-Value="@_query.SearchTerm" Placeholder="Search" Adornment="Adornment.End"
                           AdornmentIcon="@Icons.Material.Filled.Search" Margin="Margin.Dense" IconSize="Size.Small" Size="Size.Small" Variant="Variant.Outlined">
             </MudTextField>
         </MudItem>
     </MudGrid>
     <MudDataGrid T="PharmacyChainModel" ServerData="@(DataSource)"
                  Virtualize="true"
                  @bind-RowsPerPage="_defaultPageSize"
                  FilterMode="@DataGridFilterMode.ColumnFilterRow"
                  Loading="@_loading"
                  Striped="true"
                  Bordered="true"
                  Dense="true"
                  SortLabel="Order by"
                  Filterable="true"
                  MultiSelection="true"
                  @bind-SelectedItems="_selectedPharmacyChains"
                  Hideable="true"
                  Hover="true"
                  ColumnResizeMode="ResizeMode.Column"
                  DragDropColumnReordering="true"
                  ApplyDropClassesOnDragStarted="true"
                  FilterDefinitions="@_defaultFilterDefinition"
                  @ref="_table">
         <Columns>
             <SelectColumn Size="Size.Small" T="PharmacyChainModel" ShowInFooter="false"></SelectColumn>
             <TemplateColumn CellStyle="width: 50px" Title="Actions" Filterable="false" Sortable="false">
                 <CellTemplate>
                     <MudGrid Class="action-bar">
                         <MudItem>
                             <MudTooltip Text="Open" Placement="Placement.Top">
                                 <MudIconButton DisableElevation
                                                Icon="@Icons.Material.Filled.OpenInNew"
                                                Size="Size.Small"
                                                OnClick="@(() => OnOpen(context.Item))"
                                                Color="Color.Primary">
                                 </MudIconButton>
                             </MudTooltip>
                         </MudItem>
                         <MudItem>
                             <MudTooltip Text="Copy" Placement="Placement.Top">
                                 <MudIconButton DisableElevation
                                                Icon="@Icons.Material.Filled.ContentCopy"
                                                Size="Size.Small"
                                                OnClick="@(() => OnCopy(context.Item))"
                                                Disabled="@(!_userProfileState.Value.HasPermission(Permissions.CanManageSafetyStock))"
                                                Color="Color.Primary">
                                 </MudIconButton>
                             </MudTooltip>
                         </MudItem>
                         <MudItem>
                             <MudTooltip Text="More" Placement="Placement.Top">
                                 <MudMenu Class="more-horiz-icon" icon="@Icons.Material.Outlined.MoreHoriz" Variant="Variant.Text" DisableElevation="true" Size="Size.Small" Dense="true" AnchorOrigin="Origin.CenterLeft">
                                     <MudMenuItem OnClick="@(() => OnActivate(context.Item))" Disabled="@(context.Item.IsActive || !_userProfileState.Value.HasPermission(Permissions.CanManageSafetyStock))">Activate</MudMenuItem>
                                     <MudMenuItem OnClick="@(() => OnDeactivate(context.Item))" Disabled="@(!context.Item.IsActive || !_userProfileState.Value.HasPermission(Permissions.CanManageSafetyStock))">Deactivate</MudMenuItem>
                                     <MudMenuItem OnClick="@(() => OnHistoryView(context.Item))">History</MudMenuItem>
                                 </MudMenu>
                             </MudTooltip>
                        </MudItem>
                     </MudGrid>
                 </CellTemplate>
             </TemplateColumn>
                <PropertyColumn Property="x => x.DisplayName" Title="@DisplayNameHelper.Get(typeof(PharmacyChainModel), nameof(PharmacyChainModel.DisplayName))"></PropertyColumn>
                <PropertyColumn Property="x => x.E1SoldTo" Title="@DisplayNameHelper.Get(typeof(PharmacyChainModel), nameof(PharmacyChainModel.E1SoldTo))"></PropertyColumn>
                <PropertyColumn Property="x => x.Group" Title="@DisplayNameHelper.Get(typeof(PharmacyChainModel), nameof(PharmacyChainModel.Group))">
                    <FilterTemplate>
                        <AutoDictionaryFilterTemplate DataT="PharmacyChainModel" QueryT="PharmacyChainQuery"
                                AffectedGrid="@_table"
                                AffectedQuery="@_query"
                                FilterOptions="@_groupFilterOptions"
                                QueryProperty="q => q.Group"
                                SelectableOptions="@PharmacyChainData.GroupDisplayNames"></AutoDictionaryFilterTemplate>
                    </FilterTemplate>
                </PropertyColumn>
                <PropertyColumn Property="x => x.IsActive" CellStyle="width: 60px" Title="@DisplayNameHelper.Get(typeof(PharmacyChainModel), nameof(PharmacyChainModel.IsActive))">
                    <CellTemplate>
                        @if (context.Item.IsActive)
                        {
                            <MudIcon Icon="@Icons.Material.Filled.Check" Color="Color.Primary" Size="Size.Medium" />
                        }
                </CellTemplate>
                <FilterTemplate>
                    <BooleanFilterTemplate FilterOptions="@_isActiveFilterOptions" ApplyClick="@ApplyIsActiveFilter" CancelClick="@ClearIsActiveFilter" />
                </FilterTemplate>
                </PropertyColumn>
        </Columns>
        <NoRecordsContent>
            <MudText>No data to display</MudText>
        </NoRecordsContent>
        <LoadingContent>
            <MudText>Loading</MudText>
        </LoadingContent>
        <PagerContent>
            <MudDataGridPager PageSizeOptions="@(new[] { 10, 15, 30, 50, 100, 200 })" />
        </PagerContent>
    </MudDataGrid>
</MudPaper>
